<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Memory Melody ‚Äî –∏–≥—Ä–∞ –Ω–∞ –ø–∞–º—è—Ç—å</title>
<style>
  :root{
    --bg1:#0e0f1a; --bg2:#14172b;
    --panel:#141826cc; --panel-br:#2c3250;
    --text:#e9ecf8; --muted:#a3acc7;
    --good:#10b981; --bad:#ef4444;
    --pad1:#7dd3fc; /* –≥–æ–ª—É–±–æ–π */
    --pad2:#fca5a5; /* –∫–æ—Ä–∞–ª–ª */
    --pad3:#fde68a; /* —è–Ω—Ç–∞—Ä—å */
    --pad4:#86efac; /* –ª–∞–π–º */
    --glow1:rgba(125,211,252,.75);
    --glow2:rgba(252,165,165,.75);
    --glow3:rgba(253,230,138,.75);
    --glow4:rgba(134,239,172,.75);
    --accent:#6366f1;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:16px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 15% -10%, #1f2455 0%, transparent 60%),
      radial-gradient(1200px 600px at 85% 110%, #1a5447 0%, transparent 55%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
  }
  .container{
    min-height:100dvh; display:flex; flex-direction:column; align-items:center; justify-content:center;
    padding:24px; gap:16px;
  }
  .panel{
    width:min(900px, 96vw); border-radius:20px; padding:18px; background:var(--panel);
    border:1px solid var(--panel-br); box-shadow:var(--shadow); backdrop-filter: blur(8px);
  }
  header{
    display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:10px;
  }
  .title{font-weight:800; letter-spacing:.3px}
  .kpis{display:flex; gap:10px; flex-wrap:wrap}
  .chip{
    background:#0f1325; border:1px solid #2b3150; color:var(--muted);
    padding:8px 12px; border-radius:12px;
  }
  .chip b{color:var(--text)}
  .grid{
    display:grid; grid-template-columns:repeat(2, 1fr); grid-template-rows:repeat(2, 1fr);
    gap:18px; width:100%; aspect-ratio:1/1; padding:12px;
  }
  .pad{
    position:relative; border-radius:20px; cursor:pointer; user-select:none;
    box-shadow: inset 0 -8px 20px rgba(0,0,0,.35), inset 0 2px 8px rgba(255,255,255,.06), var(--shadow);
    transform:translateZ(0); transition:transform .06s ease, filter .2s ease, box-shadow .2s ease;
    outline:none; border:1px solid rgba(255,255,255,.07);
  }
  .pad:active{transform:scale(.99)}
  .pad:hover{filter:brightness(1.03)}
  .pad .shine{
    position:absolute; inset:0; border-radius:inherit;
    background: radial-gradient(400px 240px at 70% 15%, rgba(255,255,255,.22), rgba(255,255,255,0) 55%);
    pointer-events:none;
  }
  .pad[data-i="0"]{background:linear-gradient(180deg,#2b9dd6,#1171b7)}
  .pad[data-i="1"]{background:linear-gradient(180deg,#e76a6a,#c63b3b)}
  .pad[data-i="2"]{background:linear-gradient(180deg,#e9c15a,#caa22d)}
  .pad[data-i="3"]{background:linear-gradient(180deg,#34c784,#10995a)}
  .pad.active[data-i="0"]{box-shadow:0 0 24px 8px var(--glow1), var(--shadow)}
  .pad.active[data-i="1"]{box-shadow:0 0 24px 8px var(--glow2), var(--shadow)}
  .pad.active[data-i="2"]{box-shadow:0 0 24px 8px var(--glow3), var(--shadow)}
  .pad.active[data-i="3"]{box-shadow:0 0 24px 8px var(--glow4), var(--shadow)}
  .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:14px}
  .btn{
    appearance:none; border:none; background:var(--accent); color:white; font-weight:700;
    padding:12px 16px; border-radius:12px; cursor:pointer; box-shadow:var(--shadow); letter-spacing:.2px;
  }
  .btn:active{transform:translateY(1px)}
  .range{display:flex; align-items:center; gap:8px; color:var(--muted)}
  input[type="range"]{accent-color:var(--accent)}
  .sep{flex:1}
  .status{color:var(--muted)}
  .leaderboard{
    margin-top:14px; background:#0d1226; border:1px solid #2b3150; border-radius:14px; overflow:hidden
  }
  .leaderboard header{
    padding:10px 12px; border-bottom:1px solid #2b3150; color:var(--muted);
    display:flex; justify-content:space-between; align-items:center;
  }
  table{width:100%; border-collapse:collapse; font-size:14px}
  th,td{padding:10px 12px; text-align:left; border-bottom:1px solid #242a44}
  th{color:#c3c9e8; font-weight:600}
  .center{text-align:center}
  /* –û—à–∏–±–∫–∞ ‚Äî –ª—ë–≥–∫–∞—è —Ç—Ä—è—Å–∫–∞ –ø–∞–Ω–µ–ª–∏ */
  .shake{animation:shake .28s linear 1}
  @keyframes shake{
    0%{transform:translateX(0)} 25%{transform:translateX(-6px)} 50%{transform:translateX(6px)}
    75%{transform:translateX(-3px)} 100%{transform:translateX(0)}
  }
  /* –ú–æ–¥–∞–ª–∫–∞ */
  .modal{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.55); backdrop-filter: blur(4px); z-index:20; padding:20px;
  }
  .modal.open{display:flex}
  .card{
    width:min(460px, 94vw); background:var(--panel); border:1px solid var(--panel-br);
    border-radius:16px; padding:16px; box-shadow:var(--shadow)
  }
  .card h3{margin:6px 0 8px 0}
  .input{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2b3150; background:#0f1325; color:var(--text)
  }
  .note-map{font-size:13px; color:var(--muted)}
</style>
</head>
<body>
<div class="container">
  <div class="panel" id="gamePanel">
    <header>
      <div class="title">üéµ Memory Melody ‚Äî –∏–≥—Ä–∞ –Ω–∞ –ø–∞–º—è—Ç—å</div>
      <div class="kpis">
        <div class="chip">–†–∞—É–Ω–¥: <b id="round">0</b></div>
        <div class="chip">–û—á–∫–∏: <b id="score">0</b></div>
        <div class="chip">–†–µ–∫–æ—Ä–¥: <b id="best">0</b></div>
      </div>
    </header>

    <div class="grid" id="grid" aria-label="–ò–≥—Ä–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏">
      <button class="pad" data-i="0" aria-label="–ì–æ–ª—É–±–æ–π ‚Äî D5"><div class="shine"></div></button>
      <button class="pad" data-i="1" aria-label="–ö–æ—Ä–∞–ª–ª ‚Äî E5"><div class="shine"></div></button>
      <button class="pad" data-i="2" aria-label="–Ø–Ω—Ç–∞—Ä—å ‚Äî G5"><div class="shine"></div></button>
      <button class="pad" data-i="3" aria-label="–õ–∞–π–º ‚Äî A5"><div class="shine"></div></button>
    </div>

    <div class="controls">
      <button class="btn" id="startBtn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
      <div class="range">
        –ì—Ä–æ–º–∫–æ—Å—Ç—å
        <input id="vol" type="range" min="0" max="100" value="70">
      </div>
      <div class="range">
        –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–∫–∞–∑–∞
        <input id="speed" type="range" min="0" max="100" value="40" title="–í—ã—à–µ ‚Äî –±—ã—Å—Ç—Ä–µ–µ">
      </div>
      <div class="sep"></div>
      <div class="status" id="status">–ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å –∏–≥—Ä—É¬ª</div>
    </div>

    <div class="leaderboard" id="lb">
      <header><div>–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤ (–ª–æ–∫–∞–ª—å–Ω–æ)</div><div class="note-map">–ù–æ—Ç—ã: D5, E5, G5, A5</div></header>
      <table id="lbTable" aria-label="–õ–æ–∫–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤">
        <thead><tr><th>#</th><th>–ò–º—è</th><th>–û—á–∫–∏</th><th>–î–∞—Ç–∞</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∫–æ—Ä–¥–∞ -->
<div class="modal" id="modal">
  <div class="card">
    <h3>–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!</h3>
    <p>–í—ã –ø—Ä–æ—à–ª–∏ <b id="finalScore">0</b> —à–∞–≥–æ–≤. –í–≤–µ–¥–∏—Ç–µ –∏–º—è, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É —Ä–µ–∫–æ—Ä–¥–æ–≤:</p>
    <div style="display:flex; gap:10px; align-items:center; margin-top:8px">
      <input class="input" id="nameInput" maxlength="24" placeholder="–í–∞—à–µ –∏–º—è">
      <button class="btn" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <p class="note-map" style="margin-top:10px">–ü–æ—Ä–æ–≥ –ø–æ–ø–∞–¥–∞–Ω–∏—è: > 7 —à–∞–≥–æ–≤ –∑–∞ –ø–æ–ø—ã—Ç–∫—É.</p>
  </div>
</div>

<script>
(function(){
  // --------- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–≤—É–∫–∞ –∏ –∫–∞—Ä—Ç –≥–µ–π–º–ø–ª–µ—è ---------
  // –ù–æ—Ç—ã (—á–∞—Å—Ç–æ—Ç—ã –≤ –ì—Ü, —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ-—Ç–µ–º–ø–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç—Ä–æ–π, A4=440):
  // D5=587.33, E5=659.26, G5=783.99, A5=880.00
  const NOTE_FREQ = [587.33, 659.26, 783.99, 880.00];
  const COLORS = ['#7dd3fc', '#fca5a5', '#fde68a', '#86efac'];
  const pads = Array.from(document.querySelectorAll('.pad'));
  const startBtn = document.getElementById('startBtn');
  const statusEl = document.getElementById('status');
  const roundEl  = document.getElementById('round');
  const scoreEl  = document.getElementById('score');
  const bestEl   = document.getElementById('best');
  const volEl    = document.getElementById('vol');
  const speedEl  = document.getElementById('speed');
  const panelEl  = document.getElementById('gamePanel');
  const modal    = document.getElementById('modal');
  const finalScoreEl = document.getElementById('finalScore');
  const nameInput= document.getElementById('nameInput');
  const saveBtn  = document.getElementById('saveBtn');
  const lbTable  = document.querySelector('#lbTable tbody');

  // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Ä–µ–∫–æ—Ä–¥–æ–≤
  const LB_KEY = 'memory_melody_lb_v1';
  let leaderboard = loadLB();
  renderLB();

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã
  let sequence = [];            // –º–∞—Å—Å–∏–≤ –∏–Ω–¥–µ–∫—Å–æ–≤ 0..3
  let stepIndex = 0;            // —Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤ –∏–≥—Ä–æ–∫ —É–∂–µ –≤–≤—ë–ª –Ω–∞ —Ç–µ–∫—É—â–µ–º —Ä–∞—É–Ω–¥–µ
  let playingBack = false;      // –∏–¥—ë—Ç –ø–æ–∫–∞–∑ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  let running = false;          // –∞–∫—Ç–∏–≤–Ω–∞—è –ø–∞—Ä—Ç–∏—è
  let score = 0, best = +localStorage.getItem('memory_melody_best') || 0;
  bestEl.textContent = String(best);

  // --------- Web Audio API ---------
  let audioCtx = null;
  let masterGain = null;

  function initAudio(){
    if(audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = volEl.value/100;  // –≥—Ä–æ–º–∫–æ—Å—Ç—å 0..1
    masterGain.connect(audioCtx.destination);
  }

  async function ensureAudioUnlocked(){
    initAudio();
    if(audioCtx.state === 'suspended'){
      try{ await audioCtx.resume(); }catch(e){}
    }
  }

  function playTone(freq, dur=0.35){
    if(!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain= audioCtx.createGain();

    osc.type = 'sine';
    osc.frequency.value = freq;

    // –ú—è–≥–∫–∞—è –æ–≥–∏–±–∞—é—â–∞—è, —á—Ç–æ–±—ã –Ω–µ —â—ë–ª–∫–∞–ª–æ
    const now = audioCtx.currentTime;
    const g = gain.gain;
    g.setValueAtTime(0.0001, now);
    g.exponentialRampToValueAtTime(1.0, now + 0.01);
    g.exponentialRampToValueAtTime(0.0001, now + dur);

    osc.connect(gain); gain.connect(masterGain);
    osc.start(now);
    osc.stop(now + dur + 0.02);
  }

  // --------- –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ ---------
  function setStatus(msg){ statusEl.textContent = msg }

  function randInt(max){ return Math.floor(Math.random()*max) }

  function resetGame(){
    sequence = [];
    stepIndex = 0;
    score = 0;
    roundEl.textContent = '0';
    scoreEl.textContent = '0';
  }

  async function startGame(){
    await ensureAudioUnlocked();
    running = true; playingBack = false;
    resetGame();
    setStatus('–ü–æ–≤—Ç–æ—Ä—è–π—Ç–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å‚Ä¶');
    nextRound();
  }

  function nextRound(){
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω —Å–ª—É—á–∞–π–Ω—ã–π —à–∞—Ä (–ø–æ–≤—Ç–æ—Ä—ã –¥–æ–ø—É—Å–∫–∞—é—Ç—Å—è)
    sequence.push(randInt(4));
    stepIndex = 0;
    roundEl.textContent = String(sequence.length);
    playSequence();
  }

  async function playSequence(){
    playingBack = true;
    // –°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç –ø–æ–ª–∑—É–Ω–∫–∞: –±—ã—Å—Ç—Ä–µ–µ ‚Äî –∫–æ—Ä–æ—á–µ —à–∞–≥
    const speed = +speedEl.value; // 0..100
    const stepOn  = Math.max(160, 520 - speed*3.6); // –º—Å —Å–≤–µ—á–µ–Ω–∏—è
    const stepGap = Math.max(120, 360 - speed*2.4); // –ø–∞—É–∑–∞ –º–µ–∂–¥—É —à–∞–≥–∞–º–∏

    // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –≤—Ä–µ–º—è –ø—Ä–æ–∏–≥—Ä—ã—à–∞
    for(const p of pads) p.disabled = true;

    for(let i=0;i<sequence.length;i++){
      const idx = sequence[i];
      await flashPad(idx, stepOn);
      await sleep(stepGap);
    }

    for(const p of pads) p.disabled = false;
    playingBack = false;
  }

  async function flashPad(idx, duration=350){
    const pad = pads[idx];
    pad.classList.add('active');
    playTone(NOTE_FREQ[idx], duration/1000);
    // –º–∞–ª–µ–Ω—å–∫–∞—è –≤–∏–±—Ä–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
    if(navigator.vibrate) try{ navigator.vibrate(10) }catch{}
    await sleep(duration);
    pad.classList.remove('active');
  }

  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)) }

  async function handlePadInput(idx){
    if(!running || playingBack) return;
    await flashPad(idx, 220); // –∫–æ—Ä–æ—Ç–∫–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –∏–≥—Ä–æ–∫–∞
    if(sequence[stepIndex] === idx){
      stepIndex++;
      if(stepIndex === sequence.length){
        // –†–∞—É–Ω–¥ –ø—Ä–æ–π–¥–µ–Ω
        score = sequence.length;
        scoreEl.textContent = String(score);
        if(score > best){ best = score; bestEl.textContent = String(best); localStorage.setItem('memory_melody_best', String(best)) }
        await sleep(400);
        nextRound();
      }
    }else{
      // –û—à–∏–±–∫–∞ ‚Äî –∫–æ–Ω–µ—Ü –∏–≥—Ä—ã
      running = false;
      panelEl.classList.add('shake');
      setTimeout(()=>panelEl.classList.remove('shake'), 320);
      setStatus('–û—à–∏–±–∫–∞. –ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å –∏–≥—Ä—É¬ª, —á—Ç–æ–±—ã —Å—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞.');
      if(score > 7){
        // –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É —Ä–µ–∫–æ—Ä–¥–æ–≤
        finalScoreEl.textContent = String(score);
        nameInput.value = suggestName();
        modal.classList.add('open');
        nameInput.focus();
      }
    }
  }

  function suggestName(){
    const prev = localStorage.getItem('memory_melody_name');
    if(prev) return prev;
    // —Å–∫—Ä–æ–º–Ω—ã–π –∞–≤—Ç–æ–ø–æ–¥–±–æ—Ä
    const base = ['–ò–≥—Ä–æ–∫','–ú—É–∑—ã–∫–∞–Ω—Ç','Maestro','Virtuoso','Hero'];
    return base[randInt(base.length)] + '-' + (100+randInt(900));
  }

  // --------- –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤ (–ª–æ–∫–∞–ª—å–Ω–æ) ---------
  function loadLB(){
    try{
      const raw = localStorage.getItem(LB_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch{ return [] }
  }

  function saveLB(){
    try{ localStorage.setItem(LB_KEY, JSON.stringify(leaderboard)) }catch{}
  }

  function addRecord(name, score){
    leaderboard.push({ name, score, date: new Date().toISOString() });
    leaderboard.sort((a,b)=> b.score - a.score || (a.date < b.date ? 1 : -1));
    leaderboard = leaderboard.slice(0, 15); // —Ç–æ–ø-15
    saveLB();
    renderLB();
  }

  function renderLB(){
    lbTable.innerHTML = '';
    if(leaderboard.length === 0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 4; td.className = 'center'; td.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π';
      tr.appendChild(td); lbTable.appendChild(tr); return;
    }
    leaderboard.forEach((r, i)=>{
      const tr = document.createElement('tr');
      const dt = new Date(r.date);
      tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(r.name)}</td><td>${r.score}</td><td>${dt.toLocaleDateString()} ${dt.toLocaleTimeString()}</td>`;
      lbTable.appendChild(tr);
    });
  }

  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])) }

  // --------- –°–æ–±—ã—Ç–∏—è UI ---------
  startBtn.addEventListener('click', startGame);

  // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º—ã—à—å/—Ç–∞—á/—Å—Ç–∏–ª—É—Å –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ (pointerdown)
  pads.forEach(p=>{
    p.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      const idx = +p.getAttribute('data-i');
      handlePadInput(idx);
    }, { passive:false });
  });

  volEl.addEventListener('input', ()=>{
    if(!masterGain) initAudio();
    if(masterGain) masterGain.gain.value = volEl.value/100;
  });

  saveBtn.addEventListener('click', ()=>{
    const name = nameInput.value.trim() || '–ò–≥—Ä–æ–∫';
    localStorage.setItem('memory_melody_name', name);
    addRecord(name, score);
    modal.classList.remove('open');
  });

  modal.addEventListener('click', (e)=>{
    if(e.target === modal) modal.classList.remove('open');
  });

  // –ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (1,2,3,4)
  window.addEventListener('keydown', (e)=>{
    const map = { '1':0, '2':1, '3':2, '4':3 };
    if(e.key in map){ handlePadInput(map[e.key]) }
    if(e.key === 'Enter' && !running){ startGame() }
  });

  setStatus('–ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å –∏–≥—Ä—É¬ª');

})();
</script>
</body>
</html>
